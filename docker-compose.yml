# Aerial Survey Manager - Docker Compose Configuration
# 온프레미스 배포용

version: '3.8'

# 공통 로그 설정 (디스크 용량 관리)
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

# 처리 워커용 로그 설정 (디버깅 중요 - 더 큰 용량)
x-logging-worker: &worker-logging
  driver: "json-file"
  options:
    max-size: "50m"
    max-file: "5"

services:
  # === Frontend (React) ===
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - VITE_API_URL=
        - VITE_TUS_URL=/files/
    ports:
      - "3000:80"
      - "3001:5173" # Vite dev port
    environment:
      - VITE_API_URL=
      - VITE_TUS_URL=/files/
    volumes:
      - .:/app
      - /app/node_modules
    depends_on:
      - api
    networks:
      - aerial-network
    logging: *default-logging

  # === Backend API (FastAPI) ===
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8001:8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@db:5432/aerial_survey
      - REDIS_URL=redis://redis:6379/0
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=aerial-survey
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-change-this-in-production}
      - EXTERNAL_ENGINE_URL=${EXTERNAL_ENGINE_URL:-}
      - EXTERNAL_ENGINE_API_KEY=${EXTERNAL_ENGINE_API_KEY:-}
      - TUS_ENDPOINT=http://tusd:1080/files/
      - MINIO_PUBLIC_ENDPOINT=${MINIO_PUBLIC_ENDPOINT:-localhost:9002}
    volumes:
      - ./backend:/app
      - ${PROCESSING_DATA_PATH:-./data/processing}:/data/processing
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      minio:
        condition: service_started
    networks:
      - aerial-network
    logging: *default-logging

  # === tus Upload Server (Resumable Uploads) ===
  tusd:
    image: tusproject/tusd:latest
    command: >
      -s3-bucket aerial-survey
      -s3-endpoint http://minio:9000
      -s3-object-prefix uploads/
      -s3-part-size 524288000
      -hooks-http http://api:8000/api/v1/upload/hooks
      -hooks-enabled-events pre-create,post-finish,post-terminate
      -max-size 0
      -behind-proxy
      -base-path /files/
    environment:
      - AWS_ACCESS_KEY_ID=${MINIO_ACCESS_KEY:-minioadmin}
      - AWS_SECRET_ACCESS_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - AWS_REGION=us-east-1
    ports:
      - "1081:8080"
    depends_on:
      - minio
    networks:
      - aerial-network
    logging: *worker-logging

  # === Celery Worker - ODM Queue ===
  worker-odm:
    build:
      context: .
      dockerfile: engines/odm/Dockerfile
    command: celery -A app.workers.tasks worker -Q odm --loglevel=info --concurrency=2
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@db:5432/aerial_survey
      - REDIS_URL=redis://redis:6379/0
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=aerial-survey
      - MINIO_PUBLIC_ENDPOINT=${MINIO_PUBLIC_ENDPOINT:-localhost:9002}
      - HOST_DATA_PATH=${PROCESSING_DATA_PATH:-${PWD}/data/processing}
    volumes:
      - ./backend/app:/app/app
      - ${PROCESSING_DATA_PATH:-./data/processing}:/data/processing
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - redis
      - db
      - minio
    restart: always
    networks:
      - aerial-network
    logging: *worker-logging

  # === Celery Worker - External API Queue ===
  worker-external:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A app.workers.tasks worker -Q external --loglevel=info --concurrency=4
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@db:5432/aerial_survey
      - REDIS_URL=redis://redis:6379/0
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=aerial-survey
      - MINIO_PUBLIC_ENDPOINT=${MINIO_PUBLIC_ENDPOINT:-localhost:9002}
      - EXTERNAL_ENGINE_URL=${EXTERNAL_ENGINE_URL:-}
      - EXTERNAL_ENGINE_API_KEY=${EXTERNAL_ENGINE_API_KEY:-}
    volumes:
      - ./backend/app:/app/app
      - ${PROCESSING_DATA_PATH:-./data/processing}:/data/processing
    depends_on:
      - redis
      - db
    networks:
      - aerial-network
    logging: *default-logging

  # === Celery Worker - Metashape Queue ===
  worker-metashape:
    build:
      context: .
      dockerfile: engines/metashape/Dockerfile
    working_dir: /app
    command: celery -A app.workers.tasks worker -Q metashape --loglevel=info -n worker-metashape@%h
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - PYTHONPATH=/app
      - DATABASE_URL=postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@db:5432/aerial_survey
      - REDIS_URL=redis://redis:6379/0
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=aerial-survey
      - METASHAPE_LICENSE_KEY=${METASHAPE_LICENSE_KEY:-}
      - PROJECT_ID=${PROJECT_ID:-unknown}
      - PLATFORM_WEBHOOK_URL=http://api:8000/api/v1/processing/webhook
      - BACKEND_URL_ORTHO=http://api:8000/api/v1/processing
    volumes:
      - ./backend/app:/app/app
      - ./engines/metashape:/app/engines/metashape
      - ${PROCESSING_DATA_PATH:-./data/processing}:/data/processing
      - metashape-license:/var/tmp/agisoft/licensing
    depends_on:
      - redis
      - db
      - minio
    networks:
      aerial-network:
        aliases:
          - worker-metashape
    mac_address: "02:42:AC:17:00:64"  # Static MAC for stable Machine ID
    logging: *worker-logging

  # === Celery Beat (Scheduler) ===
  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A app.workers.tasks beat --loglevel=info
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@db:5432/aerial_survey
      - REDIS_URL=redis://redis:6379/0
      - MINIO_PUBLIC_ENDPOINT=${MINIO_PUBLIC_ENDPOINT:-localhost:9002}
    volumes:
      - ./backend:/app
    depends_on:
      - redis
    networks:
      - aerial-network
    logging: *default-logging

  # === PostgreSQL + PostGIS ===
  db:
    image: postgis/postgis:15-3.3
    environment:
      - POSTGRES_DB=aerial_survey
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - aerial-network
    logging: *default-logging

  # === Redis ===
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    networks:
      - aerial-network
    logging: *default-logging

  # === MinIO (S3-compatible Storage) ===
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY:-minioadmin}
    ports:
      - "9002:9000"
      - "9003:9001"  # Console UI
    volumes:
      - ${MINIO_DATA_PATH:-./data/minio}:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - aerial-network
    logging: *default-logging

  # === MinIO Bucket Init ===
  minio-init:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 ${MINIO_ACCESS_KEY:-minioadmin} ${MINIO_SECRET_KEY:-minioadmin};
      mc mb --ignore-existing myminio/aerial-survey;
      mc anonymous set download myminio/aerial-survey/public;
      exit 0;
      "
    networks:
      - aerial-network

  # === TiTiler (COG Tile Server) ===
  titiler:
    image: ghcr.io/developmentseed/titiler:0.18.0
    environment:
      # CORS - allow all origins for development
      - TITILER_API_CORS_ORIGINS=*
      # MinIO/S3 configuration
      - AWS_ACCESS_KEY_ID=${MINIO_ACCESS_KEY:-minioadmin}
      - AWS_SECRET_ACCESS_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - AWS_S3_ENDPOINT=http://minio:9000
      - AWS_VIRTUAL_HOSTING=false
      - AWS_HTTPS=false
    depends_on:
      - minio
    networks:
      - aerial-network
    logging: *default-logging

  # === Nginx Reverse Proxy ===
  nginx:
    image: nginx:alpine
    ports:
      - "8081:80"
      - "4443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - api
      - tusd
      - titiler
    networks:
      - aerial-network
    logging: *default-logging

  # === Flower (Celery Monitoring) ===
  flower:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A app.workers.tasks flower --port=5555
    environment:
      - REDIS_URL=redis://redis:6379/0
    ports:
      - "5555:5555"
    volumes:
      - ./backend:/app
    depends_on:
      - redis
    networks:
      - aerial-network
    logging: *default-logging

networks:
  aerial-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.23.0.0/16

volumes:
  pgdata:
  redis_data:
  metashape-license:
